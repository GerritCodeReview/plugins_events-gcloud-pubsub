{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "63e2a5b6_f68da21c",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/pubsub/PubSubEventSubscriber.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-04-21T18:30:11Z",
      "side": 1,
      "message": "I am thinking if we should actually ack in the finally block.\nDo we really want to ack all messages even the ones that we couldn\u0027t process?\n\nI understand perhaps we want to ack *some* messages that we couldn\u0027t process (the ones for which validate() is false), but what about deserialization exceptions for example?\n\nAlso, since there\u0027s no logging we will not even have visibility on this and effectively we will be silently acking every message that we cannot process?\n\nI have recently modified this piece of code to allow exposing failure metrics (here [1]).\n\nPerhaps let\u0027s discuss my points above and how to integrate them in the best way.\n\nWDYT?\n\n[1]https://gerrit.googlesource.com/plugins/events-gcloud-pubsub/+/refs/changes/10/304010/1/src/main/java/com/googlesource/gerrit/plugins/pubsub/PubSubEventSubscriber.java#100",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 69,
        "endChar": 27
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62830868_50ec9c87",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/pubsub/PubSubEventSubscriber.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-04-21T19:20:39Z",
      "side": 1,
      "message": "\u003e I am thinking if we should actually ack in the finally block.\n\u003e Do we really want to ack all messages even the ones that we couldn\u0027t process?\n\u003e \n\u003e I understand perhaps we want to ack *some* messages that we couldn\u0027t process (the ones for which validate() is false), but what about deserialization exceptions for example?\n\nIf this was a bank transaction or a data pipeline, we should have a DLQ. In this case, we should discard them and log the reason why we did.\n\n\u003e Also, since there\u0027s no logging we will not even have visibility on this and effectively we will be silently acking every message that we cannot process?\n\nTrue, we are missing a log at warning level here.\n\n\u003e I have recently modified this piece of code to allow exposing failure metrics (here [1]).\n\nYes, a metric would be best to count the number of messages discarded.\n\n\u003e [1]https://gerrit.googlesource.com/plugins/events-gcloud-pubsub/+/refs/changes/10/304010/1/src/main/java/com/googlesource/gerrit/plugins/pubsub/PubSubEventSubscriber.java#100",
      "parentUuid": "63e2a5b6_f68da21c",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 69,
        "endChar": 27
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "069f0598_5dd64c8d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/pubsub/PubSubEventSubscriber.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-04-22T13:20:50Z",
      "side": 1,
      "message": "I agree I should rebase on top of the metrics change.",
      "parentUuid": "62830868_50ec9c87",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 69,
        "endChar": 27
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "696fe4f4_73a4e775",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/pubsub/PubSubBrokerApiIT.java",
        "patchSetId": 1
      },
      "lineNbr": 213,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-04-21T18:30:11Z",
      "side": 1,
      "message": "Are we relying on the order of insertion? is the delivery guaranteed to be in order?\n\nI am asking because here we are asserting that the eventMessage is consumed, rather than asserting that the eventMessageWithoutSourceInstanceId is not, right?\n\nAs soon as we receive the eventMessage the test will pass without checking that the eventMessageWithoutSourceInstanceId is not received immediately after.",
      "range": {
        "startLine": 209,
        "startChar": 0,
        "endLine": 213,
        "endChar": 90
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "31b67c16_471eddc1",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/pubsub/PubSubBrokerApiIT.java",
        "patchSetId": 1
      },
      "lineNbr": 213,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-04-22T13:20:50Z",
      "side": 1,
      "message": "yeah that\u0027s why I was thinking about using mock and to validate if this message was never delivered. But I will have the same problem, how long I should wait? The only way is to rely on the message ordering. WDYT?",
      "parentUuid": "696fe4f4_73a4e775",
      "range": {
        "startLine": 209,
        "startChar": 0,
        "endLine": 213,
        "endChar": 90
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a559eb03_431bb2b4",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/pubsub/PubSubBrokerApiIT.java",
        "patchSetId": 1
      },
      "lineNbr": 213,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-04-22T13:58:09Z",
      "side": 1,
      "message": "\u003e yeah that\u0027s why I was thinking about using mock and to validate if this message was never delivered. But I will have the same problem, how long I should wait?\n\nOption1:\nWe could assert that the message is NOT received in TEST_TIMEOUT time.\nBut I agree is not the best solution, because it will slow down the tests.\n\n\u003e The only way is to rely on the message ordering. \n\nIf message ordering is guaranteed then, this approach is fine (I am not sure that\u0027s the case though).\n\nWDYT?\n\nAlternative approach:\nI was thinking that if you rebase this on top of [1] you could perhaps have something like:\n\n```\nmessageReceiver(succeedingConsumer)\n        .receiveMessage(EventMessageInstance, ackReplyConsumerMock);\n\nassertThat(consumer is called)\n```\n\nand then\n```\nmessageReceiver(succeedingConsumer)\n        .receiveMessage(EventInstance, ackReplyConsumerMock);\n\nassertThat(consumer is NOT called)\n```\n\nI believe it should be easy, but I haven\u0027t looked into it much, so I might be wrong.\n\nIf it doesn\u0027t make our life easier don\u0027t worry I would say we leave this test as it is.\n\nWDYT?\n\n\n[1]https://gerrit-review.googlesource.com/c/plugins/events-gcloud-pubsub/+/304010/1/src/test/java/com/googlesource/gerrit/plugins/pubsub/PubSubEventSubscriberTest.java",
      "parentUuid": "31b67c16_471eddc1",
      "range": {
        "startLine": 209,
        "startChar": 0,
        "endLine": 213,
        "endChar": 90
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7449bd17_e86f6cd6",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/pubsub/PubSubBrokerApiIT.java",
        "patchSetId": 1
      },
      "lineNbr": 280,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-04-21T10:40:07Z",
      "side": 1,
      "message": "I was thinking about replacing TestConsumer with mock but there is no much value",
      "range": {
        "startLine": 280,
        "startChar": 2,
        "endLine": 280,
        "endChar": 64
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2d67e6ad_2cef53ef",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/pubsub/PubSubBrokerApiIT.java",
        "patchSetId": 1
      },
      "lineNbr": 280,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-04-21T18:30:11Z",
      "side": 1,
      "message": "I think using testConsumer is fine.",
      "parentUuid": "7449bd17_e86f6cd6",
      "range": {
        "startLine": 280,
        "startChar": 2,
        "endLine": 280,
        "endChar": 64
      },
      "revId": "26db043fee7f622c9a4a241b048f7f627226c122",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}